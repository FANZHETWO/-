## 对于前端性能优化，你知道的有哪些？

### 对于CSS和HTML
CSS和HTML是否能作为两门语言，可能对于后台开发者来说可能会有点好笑，但是作为一个热爱前端的工作者，我觉得这个作为两门语言一点都不为过，至少他们在浏览器的初期，是静态页面的统领者，当然我们作为天天跟这两门语言打交道的人，也应该尽力去了解他们背后运行的原理，懂得浏览器是怎么识别他们的。了解了他们背后运行的机制后才能写出性能最优的代码。有时候我们知其然却不知所以然，我们知道HTML不能嵌套太深，但是为什么呢？我们知道CSS要尽量不要用标签名作为class类名。要动态插入样式时把所有的样式放到一个class里面要比一个一个style插入好。所以的这些知识点背后都有其存在的理由，下面就由我来带大家解开这个神秘的面纱。

##### CSS渲染的特点
> 加载CSS资源时，浏览器将不会渲染任何已处理的内容，直至CSSOM构建完毕。HTML和CSS都是阻塞渲染的资源。所以优化的空间就是尽早、 尽快的下载都客户端，以便缩短首次渲染的时间。

#### 浏览器是如何渲染的？

##### 首选会通过以下几个步骤
1、处理HTML标记并构建DOM树。
2、处理CSS标记并构建CSSOM树。
3、将DOM与CSSOM合并成一个渲染树。
4、根据渲染树来布局，以计算每个节点的几何信息。
5、将各个节点绘制到屏幕上。

**优化的关键路径就是最大限度缩短执行上述1-5步所要消耗的时间。**

##### HTML、CSS渲染过程的一些特点
1、顺序执行、并发加载
- js词法分析（AST）： 从上到下;能够把这个解析过程了解清楚的，让我来崇拜你把。
- 并发加载 ： 资源并发请求（根据浏览器不同，chrome的最大并发次数好像是6）

2、是否阻塞
- css head 中阻塞页面的渲染,这大家应该都知道。
- css 阻塞js的执行；这个肯定也是阻塞的，虽然是不同的两个线程，但是两边运行都是会影响最后的渲染结果，所以为了正常执行，只能其中一方单独运行。
- css 不阻塞外部脚本的加载。
 **js 阻塞**
- 直接引入的js阻塞页面的渲染（原因：会涉及操作dom）
- js不阻塞资源的加载
- js顺序执行，阻塞后续js逻辑的执行（原理：单线程）

*当然还有其他影响阻塞的因素，比如说依赖关系，可能其中的js运行需要依赖其他的js库，比如说我们通过vue编写的代码就需要先引入vue的库。还有引入方式的不同，是同步还是异步，通过添加defer和async来决定引入的方式。*

3、构建渲染树的过程
(1)、从 DOM树的根节点开始遍历每个可见节点。
- 某些节点不可见（例如脚本标记、元标记），因为它们不会体现在渲染输出中，所以会被忽略。
- 某些节点通过CSS隐藏，因此在渲染树中也会被忽略。**比如要是设置了display:none属性，就不会出现在渲染树中，所以对于不常用的资源可以选择使用这个属性。**
(2)、对于每个可见的节点，为其匹配CSSOM规则并应用它们。
(3)、发射可见节点，连同其内容和计算的样式。

4、visibility:hidden与display:none的区别
前者是隐藏元素，但元素仍占据着布局空间（即将其渲染成一个空旷），而后者将元素从渲染树中完全移除，元素即不可见，也不是布局的组成部分。

5、有了渲染树，接下来就是进入布局阶段（自动重排）

为了弄清每个对象在网页上确切的大小和位置，浏览器从渲染树的根节点开始遍历。布局流程的输出是一个“盒模型”，它会精确地捕获每个元素在窗口内的确切位置和尺寸，即所有相对测量值都转换为屏幕上的绝对像素。
当节点和计算样式等几何信息排列好后，就会执行最后一个阶段，将渲染树中的每个节点转换成屏幕上的实际像素。这一步通常称为“绘制”或“栅格化”

6、渲染的时间长度来源
执行渲染树的构建、布局和绘制所需的时间将取决与文档的大小、应用的样式，以及运行文档的设备：文档越大，浏览器需要完成的工作就越多；样式越复杂，绘制需要的时间就越长（例如。单色的绘制开销就比阴影的计算和渲染开销要小）

7、DOM和CSSOM合并成如下图

  ![render tree](https://developers.google.cn/web/fundamentals/performance/critical-rendering-path/images/render-tree-construction.png)


##### 重绘（Repaint）和回流（Reflow）

###### css性能让javascript变慢？
> 前面已经提到过css是阻塞js执行的，当css频繁的触发重绘与回流，会导致UI频繁渲染，最终阻塞了js的执行。

###### 概念
**回流**
- 当render tree 中的一部分（或全部）因为元素的规模尺寸，布局，隐藏等改变而需要重新构建
  。这就称为回流（reflow）
- 当页面布局和几何属性改变时就需要回流,也称为重排；

**重绘**
- 当render tree 中一些元素需要更新属性，而这些属性只是影响元素的外观，风格，而不会影响布局。比如只改变颜色和背景。这个过程称为重绘。

**区分**
- 回流必会引起重绘，但重绘不一定引起回流。

###### 哪些属性会触发页面重布局
- 盒子模型相关属性会触发重布局
width height padding margin display border-width border min-height
- 定位属性及浮动也会触发重布局
top bottom left right position float clear 
- 改变节点内部文字结构也会触发重布局
  text-align overflow-y font-weight overflow font-family line-height vertival-align white-space font-size

以上属性会影响到页面回流，所以我们在操作css样式时，尽量避免这些属性的改变。

###### CSS优化的两点根本原理
1、 避免使用触发重绘、回流的css属性
2、将重绘、回流的影响范围限制在单独的图层之内

**所以根据上面两点，平时我们的demo中可以做下面优化**

1、用translate代替top改变，因为top会引起回流。
2、用opacity代替visibility，但特别注意的地方，就是opacity要在单独的一个图层
3、不要一条一条的修改DOM样式，预先定义好clas,然后修改DOM的clasName;
4、把DOM离线修改，也就时说通过display:none先影藏节点，修改完后再显示出来。
5、不要把DOM结点的属性值放在一个循环里当成循环的里的变量，比如每当读取offsetHeight,offsetWidth,会强制刷新dom节点的缓存机制，这样会造成性能浪费。
6、不要使用table布局，因为一个小的改动都会造成整个table的重新布局
7、动画实现速度的选择最后跟浏览器的绘制帧数相吻合。也就是可以通过监听requestAnimationFrame等浏览器全局事件来做处理
8、对于动画新建图层，这样新的图层绘制不会影响其他图层。
9、通过启用GPU硬件加速(GPU即图形处理器，是与处理和绘制图形相关的硬件。GPU是专为执行复杂的数学和几何计算而设计的，可以让CPU从图形处理的任务中解放出来，从而执行其他更多的系统任务，例如，页面的计算与重绘).以前开启GPU都是通过 transform: translateZ(0);等hack手法，现在通过will-change:transform;这个属性就能达到同样的效果，但是要注意的是，用完就得抛弃（也就是将值设为will-change:auto），不然会造成资源浪费。

###### 为chrome创建图层的条件
- 3D或透视变换（perspective transform）CSS属性
- 使用加速视频解码的<video> 节点
- 拥有3D（webGL）上下文或加速的2D上下文的<canvas>节点
- 混合插件（如Flash）
- 对自己的opacity做CSS动画或使用一个动画webkit变换的元素
- 拥有加速CSS过滤器的元素
- 元素有一个包含复合层的后代节点（一个元素拥有一个子元素，该子元素在自己的层里）
- 元素有一个z-index较低且包含一个复合层的兄弟元素（即该元素在复合层上面渲染）

###### 优化性能没有强心剂的手段，只有不断的查漏补缺
> 对于CSS和HTML的优化，平时在搬砖的时候就要不断的去思考， 怎么才能写出性能最佳的代码，而不是写完出现问题了再想着怎么去优化。对于资源的优化只有平时的点滴积累，它不会像可以一针治愈的BUG，找到消灭就能够完事。而是要平时不断的思考，了解其背后运行的机制，才能写出最优的代码。

### 对于图片我们能做哪些优化

###### 我的一些感悟

有些项目用到的图片比较多，所以对于图片的优化可能会起到很关键的一环，说的夸张一些，图片要是优化的好，项目至少能优化70%。说句真实的，当我了解不同图片在不同场合的运用，以及怎么压缩优化时，我把项目体积大小优化了一半，这确实震惊到我了，原来图片优化的空间有这么大，同时我又后悔怎么不早点了解图片的这些原理，因为很多项目都已经发版上线，有些优化是做不了的，比如将小图片合并成雪碧图，或者用iconfont字体。或者在切图时就嘱咐UI小姐姐，什么时候用jpg，什么场景用png，现在项目已经上线，再改动可能性不大，除非项目老大给排期派工，哈哈，这估计是不可能的，毕竟我们公司业务逻辑比性能优化跟重要。但是对于我们自己来说，从一开始做一个项目就知道怎么去合理规划和运用那些图片，从一开始就把图片优化做好，这不仅对于我们自己来说是一个技能的提升，对于项目或者对公司来说，也是无形中省了很多流量开销，也就是为公司节省了更多的成本。

### 项目中我们都会遇见哪些图片？他们的优缺点都是什么？

###### png8/png24/png32
- png8 --- 256色+支持透明
- png24 --- 2^24色+不支持透明
- png32 --- 2^24色+支持透明

**优点**
png的优点其实很明显，彩色变现能力最好，无损压缩，能够支持透明，可以处理比较复杂的图像，也是我们UI小姐姐最喜欢用的一种格式。对于8、24、32的区别越大所对象的颜色越多，自然体积也就越大。所以除非有特性较真的场景，一般我们都只用png8就能够满足了。所以如果图片比较复杂、色彩层次比较丰富，又要透明，就使用png8。但是考虑到成本比较大的情况，要是对于页面效果没有那么高的要求，还是建议使用jpg。
**缺点**
缺点其实很明显，那就是体积对比jpg会大很多，所以不管是放到本地，还是服务器，都是要斟酌来考虑的。这里推荐两种压缩图片的工具，可以无损的压缩我们的png图片。[在线网站地址](!https://tinypng.com),还有就是可以使用[webpack的一个图片压缩插件](!https://github.com/tcoopman/image-webpack-loader),但是这个插件使用后打包会比较慢。